name: CI

# æŒç»­é›†æˆå·¥ä½œæµ - ä»£ç è´¨é‡æ£€æŸ¥
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
      
      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # æ¸…ç†å¹¶å®‰è£…ä¾èµ–
      - name: Clean install dependencies
        shell: bash
        run: |
          if [ -d "node_modules" ]; then rm -rf node_modules; fi
          if [ -f "package-lock.json" ]; then rm -f package-lock.json; fi
          npm install --no-audit --no-fund
      
      # TypeScript ç±»å‹æ£€æŸ¥
      - name: Type check
        run: npm run typecheck
      
      # æ„å»ºæµ‹è¯•
      - name: Build test
        run: npm run build
      
      # è¿è¡Œæµ‹è¯• (å¦‚æœæœ‰çš„è¯)
      - name: Run tests
        run: |
          if npm run | grep -q "test"; then
            npm test
          else
            echo "No tests found, skipping..."
          fi
        continue-on-error: true
      
      # æ£€æŸ¥æ„å»ºäº§ç‰©
      - name: Verify build output
        run: |
          if [ -d "out" ]; then
            echo "âœ… Build output directory exists"
            ls -la out/
          else
            echo "âŒ Build output directory not found"
            exit 1
          fi
  
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Clean install dependencies
        shell: bash
        run: |
          if [ -d "node_modules" ]; then rm -rf node_modules; fi
          if [ -f "package-lock.json" ]; then rm -f package-lock.json; fi
          npm install --no-audit --no-fund
      
      # æ£€æŸ¥ package.json è„šæœ¬
      - name: Check package.json scripts
        run: |
          echo "ğŸ“‹ Available npm scripts:"
          npm run | grep -E "^  [a-zA-Z]" || echo "No custom scripts found"
      
      # æ£€æŸ¥é¡¹ç›®ç»“æ„
      - name: Verify project structure
        run: |
          echo "ğŸ“ Project structure:"
          echo "âœ… Source directory:" && ls -la src/ | head -10
          echo "âœ… Scripts directory:" && ls -la scripts/
          echo "âœ… Config files:" && ls -la *.json *.ts *.js 2>/dev/null || true
      
      # æ£€æŸ¥ä¾èµ–å®‰å…¨æ€§
      - name: Security audit
        run: |
          npm audit --audit-level=moderate || echo "âš ï¸ Security vulnerabilities found, please review"
        continue-on-error: true
  
  # è·¨å¹³å°æ„å»ºæµ‹è¯•
  cross-platform:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Clean install dependencies
        shell: bash
        run: |
          if [ -d "node_modules" ]; then rm -rf node_modules; fi
          if [ -f "package-lock.json" ]; then rm -f package-lock.json; fi
          npm install --no-audit --no-fund
      
      - name: Type check
        run: npm run typecheck
      
      - name: Build test
        run: npm run build
      
      - name: Platform-specific checks
        shell: bash
        run: |
          echo "ğŸ–¥ï¸ Testing on: ${{ matrix.os }}"
          echo "ğŸ“¦ Node version: $(node --version)"
          echo "ğŸ“¦ npm version: $(npm --version)"
          
          # æ£€æŸ¥æ„å»ºè¾“å‡º
          if [ -d "out" ]; then
            echo "âœ… Build successful on ${{ matrix.os }}"
          else
            echo "âŒ Build failed on ${{ matrix.os }}"
            exit 1
          fi