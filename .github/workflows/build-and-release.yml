name: Build and Release

# è§¦å‘æ¡ä»¶ï¼šæ¨é€æ ‡ç­¾æ—¶è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ
on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é… v1.0.0, v2.1.3 ç­‰ç‰ˆæœ¬æ ‡ç­¾
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
        include:
          - os: macos-latest
            platform: mac
            artifact: '*.dmg'
          - os: windows-latest
            platform: win
            artifact: '*.exe'
          - os: ubuntu-latest
            platform: linux
            artifact: '*.AppImage'
    
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
      
      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      # æ¸…ç†å¹¶å®‰è£…ä¾èµ–
      - name: Clean install dependencies
        shell: bash
        run: |
          if [ -d "node_modules" ]; then rm -rf node_modules; fi
          if [ -f "package-lock.json" ]; then rm -f package-lock.json; fi
          npm install --no-audit --no-fund
      
      # TypeScript ç±»å‹æ£€æŸ¥
      - name: Type check
        run: npm run typecheck
      
      # æ„å»ºåº”ç”¨
      - name: Build application
        run: npm run build
      
      # æ‰“åŒ…åº”ç”¨ (macOS)
      - name: Package app (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          npm run pack
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false  # ç¦ç”¨ä»£ç ç­¾å
      
      # æ‰“åŒ…åº”ç”¨ (Windows)
      - name: Package app (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          npm run pack
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false  # ç¦ç”¨ä»£ç ç­¾å
      
      # æ‰“åŒ…åº”ç”¨ (Linux)
      - name: Package app (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          npm run pack
      
      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: claude-code-cue-${{ matrix.platform }}
          path: |
            release/${{ matrix.artifact }}
            release/*.yml
            release/*.yaml
          retention-days: 30
  
  # åˆ›å»º GitHub Release
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
      
      # ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      # åˆ›å»º Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Claude Code Cue ${{ github.ref_name }}
          body: |
            ## ğŸ‰ Claude Code Cue ${{ github.ref_name }}
            
            ### ğŸ“¦ ä¸‹è½½é“¾æ¥
            
            - **macOS**: ä¸‹è½½ `.dmg` æ–‡ä»¶
            - **Windows**: ä¸‹è½½ `.exe` æ–‡ä»¶  
            - **Linux**: ä¸‹è½½ `.AppImage` æ–‡ä»¶
            
            ### âœ¨ ä¸»è¦åŠŸèƒ½
            
            - ğŸµ ä¸º Claude Code æ·»åŠ éŸ³æ•ˆåé¦ˆ
            - ğŸ”§ å›¾å½¢åŒ–é…ç½®ç•Œé¢
            - ğŸ¯ æ™ºèƒ½å·¥å…·éŸ³æ•ˆæ˜ å°„
            - ğŸŒ è·¨å¹³å°æ”¯æŒ (macOS, Windows, Linux)
            - ğŸ¨ ç°ä»£åŒ– UI è®¾è®¡
            
            ### ğŸ“‹ ä½¿ç”¨è¯´æ˜
            
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
            2. å®‰è£…å¹¶è¿è¡Œ Claude Code Cue
            3. é…ç½®éŸ³æ•ˆè®¾ç½®
            4. ç‚¹å‡»"åº”ç”¨é…ç½®"ç”Ÿæˆ Hook è„šæœ¬
            5. åœ¨ Claude Code ä¸­äº«å—éŸ³æ•ˆä½“éªŒ
            
            ---
            
            **å®Œæ•´æ›´æ–°æ—¥å¿—**: [æŸ¥çœ‹æäº¤å†å²](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }})
          draft: false
          prerelease: false
          files: |
            ./artifacts/claude-code-cue-mac/*.dmg
            ./artifacts/claude-code-cue-win/*.exe
            ./artifacts/claude-code-cue-linux/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}