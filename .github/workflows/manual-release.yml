name: Manual Release

# æ‰‹åŠ¨è§¦å‘çš„å‘å¸ƒå·¥ä½œæµ
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        type: boolean
        default: false
      platforms:
        description: 'æ„å»ºå¹³å°'
        type: choice
        options:
          - 'all'
          - 'macos-only'
          - 'windows-only'
          - 'linux-only'
        default: 'all'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: mac
            artifact: '*.dmg'
            condition: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'macos-only' }}
          - os: windows-latest
            platform: win
            artifact: '*.exe'
            condition: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'windows-only' }}
          - os: ubuntu-latest
            platform: linux
            artifact: '*.AppImage'
            condition: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'linux-only' }}
    
    runs-on: ${{ matrix.os }}
    if: ${{ matrix.condition }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Type check
        run: npm run typecheck
      
      - name: Build application
        run: npm run build
      
      - name: Package app
        run: npm run pack
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: claude-code-cue-${{ matrix.platform }}-${{ github.event.inputs.version }}
          path: |
            release/${{ matrix.artifact }}
            release/*.yml
            release/*.yaml
          retention-days: 30
  
  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Claude Code Cue ${{ github.event.inputs.version }}
          body: |
            ## ğŸ‰ Claude Code Cue ${{ github.event.inputs.version }}
            
            > ğŸ“ **æ‰‹åŠ¨å‘å¸ƒç‰ˆæœ¬** - é€šè¿‡ GitHub Actions æ‰‹åŠ¨è§¦å‘æ„å»º
            
            ### ğŸ“¦ ä¸‹è½½é“¾æ¥
            
            é€‰æ‹©é€‚åˆæ‚¨æ“ä½œç³»ç»Ÿçš„å®‰è£…åŒ…ï¼š
            
            - ğŸ **macOS**: ä¸‹è½½ `.dmg` æ–‡ä»¶
            - ğŸªŸ **Windows**: ä¸‹è½½ `.exe` æ–‡ä»¶  
            - ğŸ§ **Linux**: ä¸‹è½½ `.AppImage` æ–‡ä»¶
            
            ### âœ¨ ä¸»è¦åŠŸèƒ½
            
            - ğŸµ **éŸ³æ•ˆåé¦ˆ**: ä¸º Claude Code å·¥å…·è°ƒç”¨æ·»åŠ éŸ³æ•ˆ
            - ğŸ›ï¸ **å›¾å½¢åŒ–é…ç½®**: ç›´è§‚çš„éŸ³æ•ˆé…ç½®ç•Œé¢
            - ğŸ¤– **æ™ºèƒ½æ˜ å°„**: è‡ªåŠ¨è¯†åˆ«å·¥å…·ç±»å‹å¹¶æ’­æ”¾å¯¹åº”éŸ³æ•ˆ
            - ğŸŒ **è·¨å¹³å°**: æ”¯æŒ macOSã€Windows å’Œ Linux
            - ğŸ¨ **ç°ä»£ UI**: åŸºäº React çš„ç°ä»£åŒ–ç•Œé¢è®¾è®¡
            - âš™ï¸ **çµæ´»é…ç½®**: æ”¯æŒè‡ªå®šä¹‰éŸ³æ•ˆå’Œ"æ— éŸ³æ•ˆ"é€‰é¡¹
            
            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            
            1. **ä¸‹è½½**: é€‰æ‹©å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
            2. **å®‰è£…**: åŒå‡»å®‰è£…åŒ…è¿›è¡Œå®‰è£…
            3. **é…ç½®**: æ‰“å¼€åº”ç”¨ï¼Œé…ç½®æ‚¨å–œæ¬¢çš„éŸ³æ•ˆ
            4. **åº”ç”¨**: ç‚¹å‡»"åº”ç”¨é…ç½®"æŒ‰é’®
            5. **äº«å—**: åœ¨ Claude Code ä¸­ä½“éªŒéŸ³æ•ˆåé¦ˆ
            
            ### ğŸ”§ æŠ€æœ¯æ ˆ
            
            - **å‰ç«¯**: React + TypeScript + Vite
            - **åç«¯**: Electron + Node.js
            - **æ„å»º**: electron-builder
            - **CI/CD**: GitHub Actions
            
            ---
            
            ğŸ’¡ **æç¤º**: å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ [é¡¹ç›®æ–‡æ¡£](https://github.com/${{ github.repository }}) æˆ–æäº¤ [Issue](https://github.com/${{ github.repository }}/issues)
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            ./artifacts/claude-code-cue-mac-${{ github.event.inputs.version }}/*.dmg
            ./artifacts/claude-code-cue-win-${{ github.event.inputs.version }}/*.exe
            ./artifacts/claude-code-cue-linux-${{ github.event.inputs.version }}/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}